<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆå“¡å·¥æ™‚èª¿æŸ¥-Sankey Chart ç”¢ç”Ÿå™¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="sankey.css">

</head>
<body>
    <h1>æˆå“¡å·¥æ™‚èª¿æŸ¥-Sankey Chart ç”¢ç”Ÿå™¨</h1>
    <p>è«‹ä¸Šå‚³ Excel æª”æ¡ˆï¼Œç³»çµ±æœƒè‡ªå‹•ç”¢ç”Ÿ Sankey åœ–è¡¨</p>
    
    <div class="container">
        <div class="upload-section">
            <div class="section-title">ä¸Šå‚³ Excel æª”æ¡ˆ</div>
            <div class="drag-drop-area" id="dragDropArea">
                <div class="folder-icon">ğŸ“</div>
                <div>Drag and drop file here</div>
                <div class="file-info">Limit 200MB per file â€¢ XLSX</div>
                <button class="browse-btn" onclick="document.getElementById('fileInput').click()">Browse files</button>
                <input type="file" id="fileInput" accept=".xlsx" style="display: none;" />
            </div>
            
            <div id="fileList" class="file-list"></div>
        </div>
        
        <div id="userSelectSection" class="user-select-container hidden">
            <div class="section-title">é¸æ“‡è¦é¡¯ç¤ºçš„ä½¿ç”¨è€…</div>
            
            <div class="select-actions">
                <button class="action-btn" id="selectAllBtn">å…¨é¸</button>
                <button class="action-btn" id="selectNoneBtn">æ¸…é™¤</button>
            </div>
            
            <div class="all-users-grid" id="allUsersGrid">
                <!-- User checkboxes will be added here -->
            </div>
            
            <div class="section-title">å·²é¸æ“‡çš„ä½¿ç”¨è€…</div>
            <div class="selected-users" id="selectedUsers">
                <!-- Selected user pills will be added here -->
            </div>
            
            <div class="actions-container">
                <button class="generate-btn" id="generateChartBtn">ç”¢ç”Ÿåœ–è¡¨</button>
                <button class="options-btn" id="optionsBtn">â‹®</button>
            </div>
        </div>
        
        <div id="chartSection" class="hidden">
            <div class="section-title">Sankey åœ–è¡¨</div>
            <div id="chartContainer" class="chart-container"></div>
        </div>
    </div>
    
    <div class="footer">
        æœ‰å•é¡Œè«‹è¯çµ¡: <a href="mailto:pineapple168.mg11@nycu.edu.tw">cphsiao-20250201</a>
    </div>
    
    <script>
        let workData = null;
        let uniqueNames = [];
        let selectedNames = [];
        let chart = null;
        
        // Set up file input and drag-drop area
        const fileInput = document.getElementById('fileInput');
        const dragDropArea = document.getElementById('dragDropArea');
        const fileList = document.getElementById('fileList');
        
        // Handle file selection
        fileInput.addEventListener('change', handleFileSelection);
        
        // Set up drag and drop
        dragDropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            dragDropArea.style.borderColor = '#4CAF50';
        });
        
        dragDropArea.addEventListener('dragleave', () => {
            dragDropArea.style.borderColor = '#aaa';
        });
        
        dragDropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dragDropArea.style.borderColor = '#aaa';
            if (e.dataTransfer.files.length > 0) {
                fileInput.files = e.dataTransfer.files;
                handleFileSelection();
            }
        });
        
        function handleFileSelection() {
            const file = fileInput.files[0];
            
            if (file) {
                // Display file in the list
                fileList.innerHTML = `
                    <div class="file-item">
                        <div>
                            <span class="file-icon">ğŸ“„</span>
                            ${file.name}
                        </div>
                        <span class="file-remove" onclick="removeFile()">Ã—</span>
                    </div>
                `;
                
                // Process the file
                processExcelFile(file);
            }
        }
        
        function removeFile() {
            fileInput.value = '';
            fileList.innerHTML = '';
            document.getElementById('userSelectSection').classList.add('hidden');
            document.getElementById('chartSection').classList.add('hidden');
            if (chart) {
                chart.dispose();
                chart = null;
            }
            workData = null;
            uniqueNames = [];
            selectedNames = [];
        }
        
        function processExcelFile(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                
                // Get the first sheet
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                
                // Convert to JSON
                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                
                // Check required columns
                const requiredColumns = ["å§“å", "å…¬å‹™é ç®—å·¥æ™‚ç¸½è¨ˆ", "å°ˆæ¡ˆä»»å‹™å·¥æ™‚ç¸½è¨ˆ"];
                const hasRequiredColumns = requiredColumns.every(col => 
                    jsonData.length > 0 && Object.keys(jsonData[0]).includes(col)
                );
                
                if (!hasRequiredColumns) {
                    alert("Excel æª”æ¡ˆç¼ºå°‘å¿…è¦çš„æ¬„ä½ï¼è«‹ç¢ºèªæ¬„ä½åç¨±æ˜¯å¦æ­£ç¢ºã€‚");
                    return;
                }
                
                workData = jsonData;
                
                // Get unique names
                uniqueNames = [...new Set(jsonData.map(row => row["å§“å"]))];
                
                // Default select first 5 names (or all if less than 5)
                selectedNames = uniqueNames.slice(0, Math.min(5, uniqueNames.length));
                
                // Initialize user selection grid
                initializeUserGrid();
                
                // Show user selection section
                document.getElementById('userSelectSection').classList.remove('hidden');
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        function initializeUserGrid() {
            const allUsersGrid = document.getElementById('allUsersGrid');
            allUsersGrid.innerHTML = '';
            
            uniqueNames.forEach((name, index) => {
                const isSelected = selectedNames.includes(name);
                
                const userHtml = `
                    <div>
                        <input type="checkbox" id="user-${index}" class="user-checkbox" ${isSelected ? 'checked' : ''} 
                            onchange="toggleUser('${name}', this.checked)">
                        <label for="user-${index}" class="user-label">${name}</label>
                    </div>
                `;
                
                allUsersGrid.innerHTML += userHtml;
            });
            
            // Update selected users display
            updateSelectedUsers();
        }
        
        function toggleUser(name, isChecked) {
            if (isChecked && !selectedNames.includes(name)) {
                selectedNames.push(name);
            } else if (!isChecked) {
                selectedNames = selectedNames.filter(n => n !== name);
            }
            
            updateSelectedUsers();
        }
        
        function updateSelectedUsers() {
            const selectedUsersContainer = document.getElementById('selectedUsers');
            selectedUsersContainer.innerHTML = '';
            
            if (selectedNames.length === 0) {
                selectedUsersContainer.innerHTML = '<div style="color: #999;">æœªé¸æ“‡ä»»ä½•ä½¿ç”¨è€…</div>';
                return;
            }
            
            selectedNames.forEach(name => {
                const pill = document.createElement('div');
                pill.className = 'user-pill';
                pill.innerHTML = `
                    <span class="user-pill-text">${name}</span>
                    <span class="user-pill-remove" onclick="removeSelectedUser('${name}')">Ã—</span>
                `;
                selectedUsersContainer.appendChild(pill);
            });
        }
        
        function removeSelectedUser(name) {
            // Update selectedNames array
            selectedNames = selectedNames.filter(n => n !== name);
            
            // Update checkbox in grid
            const index = uniqueNames.indexOf(name);
            if (index !== -1) {
                const checkbox = document.getElementById(`user-${index}`);
                if (checkbox) checkbox.checked = false;
            }
            
            // Update selected users display
            updateSelectedUsers();
        }
        
        // Action buttons event listeners
        document.getElementById('selectAllBtn').addEventListener('click', function() {
            selectedNames = [...uniqueNames];
            initializeUserGrid();
        });
        
        document.getElementById('selectNoneBtn').addEventListener('click', function() {
            selectedNames = [];
            initializeUserGrid();
        });
        
        document.getElementById('generateChartBtn').addEventListener('click', function() {
            if (selectedNames.length === 0) {
                alert("è«‹è‡³å°‘é¸æ“‡ä¸€å€‹ä½¿ç”¨è€…");
                return;
            }
            
            generateSankeyChart();
            
            // Show chart section
            document.getElementById('chartSection').classList.remove('hidden');
            
            // æ²å‹•åˆ°åœ–è¡¨å€åŸŸ
            document.getElementById('chartSection').scrollIntoView({ behavior: 'smooth' });
        });
        
        function determineCategories(data) {
            const columns = Object.keys(data[0]);
            let categories = {};
            
            // å§“åæ¬„ä½å¿…é ˆæœ‰
            const nameIndex = columns.indexOf("å§“å");
            if (nameIndex === -1) return null;
            
            // å°‹æ‰¾å…¬å‹™é ç®—å’Œå°ˆæ¡ˆä»»å‹™çš„ç´¢å¼•
            const publicBudgetIndex = columns.indexOf("å…¬å‹™é ç®—å·¥æ™‚ç¸½è¨ˆ");
            const projectTaskIndex = columns.indexOf("å°ˆæ¡ˆä»»å‹™å·¥æ™‚ç¸½è¨ˆ");
            
            if (publicBudgetIndex === -1 || projectTaskIndex === -1) return null;
            
            // é‡å°ä¸åŒé¡å‹çš„æ¬„ä½é€²è¡Œåˆ†é¡
            categories.names = ["å§“å"];
            
            // å¦‚æœå…¬å‹™é ç®—åœ¨å°ˆæ¡ˆä»»å‹™ä¹‹å‰
            if (publicBudgetIndex < projectTaskIndex) {
                categories.publicBudget = {
                    total: "å…¬å‹™é ç®—å·¥æ™‚ç¸½è¨ˆ",
                    details: columns.slice(nameIndex + 1, publicBudgetIndex)
                };
                
                categories.projectTask = {
                    total: "å°ˆæ¡ˆä»»å‹™å·¥æ™‚ç¸½è¨ˆ",
                    details: columns.slice(publicBudgetIndex + 1, projectTaskIndex)
                };
                
                categories.others = columns.slice(projectTaskIndex + 1);
            } else {
                categories.projectTask = {
                    total: "å°ˆæ¡ˆä»»å‹™å·¥æ™‚ç¸½è¨ˆ",
                    details: columns.slice(nameIndex + 1, projectTaskIndex)
                };
                
                categories.publicBudget = {
                    total: "å…¬å‹™é ç®—å·¥æ™‚ç¸½è¨ˆ",
                    details: columns.slice(projectTaskIndex + 1, publicBudgetIndex)
                };
                
                categories.others = columns.slice(publicBudgetIndex + 1);
            }
            
            return categories;
        }
        
        function generateSankeyChart() {
            if (chart) {
                chart.dispose();
            }

            // é¸å–è³‡æ–™
            const filteredData = workData.filter(row => selectedNames.includes(row["å§“å"]));
            if (filteredData.length === 0) {
                alert("æ²’æœ‰ç¬¦åˆé¸æ“‡æ¢ä»¶çš„æ•¸æ“š");
                return;
            }

            const columns = Object.keys(filteredData[0]);
            const publicTotalIdx = columns.indexOf("å…¬å‹™é ç®—å·¥æ™‚ç¸½è¨ˆ");
            const projectTotalIdx = columns.indexOf("å°ˆæ¡ˆä»»å‹™å·¥æ™‚ç¸½è¨ˆ");

            const snackCols = columns.slice(publicTotalIdx + 1, projectTotalIdx);
            const stationeryCols = columns.slice(projectTotalIdx + 1);

            let dfLong = [];

            // æ•´ç†å…¬å‹™é ç®—è³‡æ–™
            filteredData.forEach(row => {
                snackCols.forEach(col => {
                    const value = parseFloat(row[col]);
                    if (!isNaN(value) && value > 0) {
                        dfLong.push({
                            name: row["å§“å"],
                            subCategory: col,
                            totalCategory: "å…¬å‹™é ç®—å·¥æ™‚ç¸½è¨ˆ",
                            value: value
                        });
                    }
                });
            });

            // æ•´ç†å°ˆæ¡ˆä»»å‹™è³‡æ–™
            filteredData.forEach(row => {
                stationeryCols.forEach(col => {
                    const value = parseFloat(row[col]);
                    if (!isNaN(value) && value > 0) {
                        dfLong.push({
                            name: row["å§“å"],
                            subCategory: col,
                            totalCategory: "å°ˆæ¡ˆä»»å‹™å·¥æ™‚ç¸½è¨ˆ",
                            value: value
                        });
                    }
                });
            });

            // å»ºç«‹ç¯€é»
            const nodesSet = new Set();
            dfLong.forEach(item => {
                nodesSet.add(item.name);
                nodesSet.add(item.subCategory);
                nodesSet.add(item.totalCategory);
            });
            const nodes = Array.from(nodesSet).map(name => ({ name }));

            // å»ºç«‹é€£çµ
            const links = [];

            dfLong.forEach(item => {
                links.push({
                    source: item.name,
                    target: item.subCategory,
                    value: item.value
                });
                links.push({
                    source: item.subCategory,
                    target: item.totalCategory,
                    value: item.value
                });
            });

            // å‹•æ…‹èª¿æ•´åœ–è¡¨é«˜åº¦
            const chartContainer = document.getElementById('chartContainer');
            const minHeight = 700;
            const heightPerNode = 30;
            chartContainer.style.height = Math.max(minHeight, nodes.length * heightPerNode) + 'px';

            chart = echarts.init(chartContainer);

            const option = {
                title: {
                    text: 'Sankey åœ–è¡¨',
                    left: 'center',
                    top: 10,
                    textStyle: { fontSize: 20 }
                },
                tooltip: {
                    trigger: 'item',
                    triggerOn: 'mousemove',
                    formatter: function (params) {
                        if (params.dataType === 'node') {
                            return params.name;
                        } else {
                            return `${params.data.source} â†’ ${params.data.target}: ${params.data.value}`;
                        }
                    }
                },
                series: [
                    {
                        type: 'sankey',
                        left: 50,
                        right: 150,
                        top: 50,
                        bottom: 50,
                        nodeWidth: 20,
                        nodeGap: 15,
                        layoutIterations: 100,
                        data: nodes,
                        links: links,
                        emphasis: { focus: 'adjacency' },
                        lineStyle: {
                            color: 'source',
                            curveness: 0.5,
                            opacity: 0.3
                        },
                        itemStyle: {
                            borderWidth: 1,
                            borderColor: '#aaa'
                        },
                        label: {
                            fontSize: 14,
                            position: 'right',
                            formatter: '{b}'
                        },
                        draggable: true,
                        animation: true,
                        animationDuration: 1000,
                        animationEasing: 'cubicOut'
                    }
                ]
            };

            chart.setOption(option);

            window.addEventListener('resize', function () {
                if (chart) chart.resize();
            });
        }
    </script>
</body>
</html>